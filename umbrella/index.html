<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/BioKT/PLUMED-docs/umbrella/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Umbrella sampling - BioKT-PLUMED-docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Umbrella sampling";
        var mkdocs_page_input_path = "umbrella.md";
        var mkdocs_page_url = "/BioKT/PLUMED-docs/umbrella/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> BioKT-PLUMED-docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../setup/">Setup</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Umbrella sampling</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#alanine-dipeptide-in-vacuum">Alanine dipeptide in vacuum</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../metadynamics/">Metadynamics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replicas/">Multiple replicas</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dipc/">PLUMED@DIPC</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">BioKT-PLUMED-docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Umbrella sampling</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p><script
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
  type="text/javascript">
</script>
</p>
<h2 id="umbrella-sampling-with-plumed">Umbrella sampling with PLUMED</h2>
<h3 id="alanine-dipeptide-in-vacuum">Alanine dipeptide in vacuum</h3>
<p>First of all, we will download the data required to run the calculations, which should be in the <code>data/umbrella</code> folder of this repository.
It should contain the following files</p>
<pre><code>$ ls data/umbrella/
    reference.pdb topolA.tpr    topolB.tpr
</code></pre>
<p>Using the typical Gromacs syntax, you could use these <code>tpr</code> files 
to run MD simulations using </p>
<pre><code>$ gmx mdrun -plumed plumed.dat -s topolA.tpr -nsteps 200000 -x traj_unbiased.xtc
</code></pre>
<p>This will result in an unbiased simulation trajectory of the 
alanine dipeptide. </p>
<p>When we run simulations with the PLUMED we will use an additional
flag <code>-plumed</code> that points to the unique input required to bias the 
simulations. Below, you can find an example input file to
estimate the values of the \( \phi \) and \( \psi \) dihedrals 
and histogram their values.</p>
<pre><code>MOLINFO STRUCTURE=reference.pdb
phi: TORSION ATOMS=@phi-2
psi: TORSION ATOMS=@psi-2

# make histograms
hhphi: HISTOGRAM ARG=phi STRIDE=100 GRID_MIN=-pi GRID_MAX=pi GRID_BIN=600 BANDWIDTH=0.05
ffphi: CONVERT_TO_FES GRID=hhphi
DUMPGRID GRID=ffphi FILE=fes_phi.dat STRIDE=200000

hhpsi: HISTOGRAM ARG=psi STRIDE=100 GRID_MIN=-pi GRID_MAX=pi GRID_BIN=600 BANDWIDTH=0.05
ffpsi: CONVERT_TO_FES GRID=hhpsi
DUMPGRID GRID=ffpsi FILE=fes_psi.dat STRIDE=200000

PRINT ARG=phi,psi FILE=colvar.dat STRIDE=100
</code></pre>
<p>Note that we are using a number of actions (<code>TORSION</code>, 
<code>HISTOGRAM</code> and <code>DUMPGRID</code>, to name a few). You should 
familiarize yourself with their 
<a href="https://www.plumed.org/doc-v2.7/user-doc/html/glossary.html">syntax</a>.</p>
<p>Introducing an umbrella bias in this script is exceedingly 
easy. It just requires adding an extra line to the script.
For example, to restrain the simulation with a harmonic
potential at 0 radians with a spring constant of 200,
we would write </p>
<pre><code># add restraining potential
bb: RESTRAINT ARG=phi KAPPA=200.0 AT=0
</code></pre>
<p>Of course, we will be interested in running multiple 
window umbrella sampling, and hence the structure of
our directory should change with as many plumed files
as umbrellas windows. To generate 32 PLUMED input files, 
we can use the following Python script:</p>
<pre><code>at=np.linspace(-np.pi,np.pi,33)[:-1]
print(at)
for i in range(32):
    with open("plumed_" + str(i) + ".dat","w") as f:
        print("""
# vim:ft=plumed
MOLINFO STRUCTURE=reference.pdb
phi: TORSION ATOMS=@phi-2 
psi: TORSION ATOMS=@psi-2
bb: RESTRAINT ARG=phi KAPPA=200.0 AT={}
PRINT ARG=phi,psi,bb.bias FILE=colvar_multi_{}.dat STRIDE=100
""".format(at[i],i),file=f)
</code></pre>
<p>And then we will run the 32 simulations</p>
<pre><code>$&gt; for i in $(seq 0 1 31);
do 
gmx mdrun -plumed plumed_${i}.dat -s topolA.tpr -nsteps 200000 -x traj_comp_${i}.xtc
done
</code></pre>
<p>The result from this will be a dataset of 32 simulations, all
initialized at the same conformation, but with umbrella potentials
that will bias the sampling to different regions of conformational
space.</p>
<p>After completion of the runs, we must analyze the resulting 
trajectories. In order to do that we concatenate the trajectories</p>
<pre><code>$ gmx trjcat -cat -f `for i in $(seq 0 1 31); do echo "traj_comp_${i}.xtc"; done` -o traj_multi_cat.xtc
</code></pre>
<p>Then, we analyze them using plumed driver:</p>
<pre><code>$ for i in $(seq 0 1 31)
do 
plumed driver --plumed plumed_${i}.dat --ixtc traj_multi_cat.xtc --trajectory-stride 100
done
</code></pre>
<p>To visualize the output of the simulations, we can read the 
<code>colvar_multi_\*.dat</code> files and see what region of the 
Ramachandran map has been sampled by each of the runs. Using
a Jupyter-notebook we can run the following </p>
<pre><code>import plumed
import wham

col=[]
for i in range(32):
    col.append(plumed.read_as_pandas("colvar_multi_" + str(i)+".dat"))

bias = np.zeros((len(col[0]["bb.bias"]),32))
for i in range(32):
    bias[:,i] = col[i]["bb.bias"][-len(bias):]
w = wham.wham(bias,T=kBT)
colvar = col[0]
colvar["logweights"] = w["logW"]
plumed.write_pandas(colvar,"bias_multi.dat")
</code></pre>
<p>We then write a file called <code>plumed_multi.dat</code> to obtain 
reweighted free energy surfaces. The file should look as
follows:</p>
<pre><code># vim:ft=plumed
phi: READ FILE=bias_multi.dat VALUES=phi IGNORE_TIME
psi: READ FILE=bias_multi.dat VALUES=psi IGNORE_TIME
lw: READ FILE=bias_multi.dat VALUES=logweights IGNORE_TIME

hhphi: HISTOGRAM ARG=phi GRID_MIN=-pi GRID_MAX=pi GRID_BIN=600 BANDWIDTH=0.05
ffphi: CONVERT_TO_FES GRID=hhphi
DUMPGRID GRID=ffphi FILE=fes_phi_cat.dat

hhpsi: HISTOGRAM ARG=psi GRID_MIN=-pi GRID_MAX=pi GRID_BIN=600 BANDWIDTH=0.05
ffpsi: CONVERT_TO_FES GRID=hhpsi
DUMPGRID GRID=ffpsi FILE=fes_psi_cat.dat

hhphir: HISTOGRAM ARG=phi GRID_MIN=-pi GRID_MAX=pi GRID_BIN=600 BANDWIDTH=0.05 LOGWEIGHTS=lw
ffphir: CONVERT_TO_FES GRID=hhphir
DUMPGRID GRID=ffphir FILE=fes_phi_catr.dat

hhpsir: HISTOGRAM ARG=psi GRID_MIN=-pi GRID_MAX=pi GRID_BIN=600 BANDWIDTH=0.05 LOGWEIGHTS=lw
ffpsir: CONVERT_TO_FES GRID=hhpsir
DUMPGRID GRID=ffpsir FILE=fes_psi_catr.dat
</code></pre>
<p>This script is again read by plumed driver, and from this program we get our outputs.</p>
<p>Clearly, using umbrella sampling we have been able to cover much more ground for our reaction coordinates, while obtaining a very consistent PMF in the regions that actually matter.
One of the assignments in the masterclass is to run from a different initial state. I try this repeating what weâ€™ve done from topolA.tpr:
$&gt; for i in $(seq 0 1 31); do gmx mdrun -plumed plumed_${i}.dat -s topolB.tpr -nsteps 200000 -x traj_comp_B_${i}.xtc; done
$ gmx trjcat -cat -f <code>for i in $(seq 0 1 31); do echo "traj_comp_B_${i}.xtc"; done</code> -o traj_multi_B_cat.xtc
I generate the corresponding plumed_B_${i}.dat  files for plumed driver and run:
$ for i in $(seq 0 1 31)
do
plumed driver --plumed plumed_B_${i}.dat --ixtc traj_multi_B_cat.xtc --trajectory-stride 100
done</p>
<p>Below I compare the sampling from topolA (left) and from topolB (right). There are very interesting differences, particularly with respect to the positive phi region, which is very much not sampled when we start to run dynamics from the topolB.</p>
<p>The results are interesting as we find that there certainly is some influence in the initial conditions for umbrella sampling.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../setup/" class="btn btn-neutral float-left" title="Setup"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../metadynamics/" class="btn btn-neutral float-right" title="Metadynamics">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../setup/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../metadynamics/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
