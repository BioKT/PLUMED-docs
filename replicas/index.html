<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/BioKT/PLUMED-docs/replicas/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Multiple replicas - BioKT-PLUMED-docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Multiple replicas";
        var mkdocs_page_input_path = "replicas.md";
        var mkdocs_page_url = "/BioKT/PLUMED-docs/replicas/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> BioKT-PLUMED-docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../setup/">Setup</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../umbrella/">Umbrella sampling</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Metadynamics</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../metadynamics/metadynamics/">Alanine dipeptide in vacuum</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../metadynamics/metadynamics-with-Q/">Defining Q as collective variable</a>
                  </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Multiple replicas</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#rest2">REST2</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dipc/">PLUMED@DIPC</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">BioKT-PLUMED-docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Multiple replicas</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p><script
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
  type="text/javascript">
</script>
</p>
<h2 id="working-with-multiple-replicas">Working with multiple replicas</h2>
<p>For a general description of how to integrate PLUMED when working with multiple
replicas, check the PLUMED <a href="https://github.com/plumed/masterclass-21-5">masterclass 21.5</a>.
Note that for using this you will need both PLUMED and Gromacs to be installed 
using MPI. Check installation instructions 
<a href="https://www.plumed.org/doc-v2.8/user-doc/html/_installation.html">here</a>.</p>
<h3 id="rest2">REST2</h3>
<p>Here we illustrate how to use the replica exchage with solute tempering method in its 
second iteration (i.e. <a href="https://doi.org/10.1021/jp204407d">REST2</a>), which uses a different
 scaling scheme that the original <a href="https://doi.org/10.1073/pnas.0506346102">REST</a>.
Before you start, please check the materials at the PLUMED website on <a href="https://www.plumed.org/doc-v2.7/user-doc/html/hrex.html">Hamiltonian
replica exchange</a>.</p>
<p>The first thing to check is whether all the files you will need are available in your folder. 
In the terminal, type</p>
<pre><code>$ ls data/replex
</code></pre>
<p>You should find a number of files, including the Gromacs structure file <code>alaTB_ff03_tip3p_npt.gro</code>
and another file called <code>alaTB_ff03_tip3p_pp.top</code>. The former is a properly equilibrated 
structure file, of the alanine dipeptide in TIP3P water. The latter is a pre-processed topology
 containing all the information required to run a simulation, and
hence devoid of <a href="https://manual.gromacs.org/current/dev-manual/includestyle.html"><code>include</code> directives</a>.
Note that in the <code>[ atoms ]</code> section, we have modified the standard names of the atoms with
an underscore (i.e. <code>HC</code> is now <code>HC_</code>). This will mark these atoms as the solute whose
interactions will be scaled in the REST2 scheme.</p>
<p>The first step is hence to scale the interactions, and in order to do this, we
use PLUMED `partial_tempering' program. Because we are running multiple 
replicas, each with a different scaling, the command will be run inside a loop
in the following Python script:</p>
<pre><code>import sys, os

gro = "alaTB_ff03_tip3p_npt.gro"
toppp = "alaTB_ff03_tip3p_pp.top"
mdp = "sd_nvt.mdp"

# scale solute interactions
nrep = 4
tmax = 1000
t0 = 300
for i in range(nrep):
    exponent = i/(nrep - 1)
    ti = t0*(tmax/t0)**exponent 
    lmbd = t0/ti

    folder = "rep%i"%i
    try:
        os.mkdir(folder)
    except OSError as e:
        print (e)

    command = "plumed partial_tempering %g &lt; %s &gt; %s/scaled.top"%(lmbd, toppp, folder)
    os.system(command)

    top = "%s/scaled.top"%folder 
    tpr = "%s/alaTB_ff03_tip3p_nvt.tpr"%folder
    command = gmx + " grompp -f %s -p %s -c %s -o %s"%(mdp, top, gro, tpr)
    os.system(command)
</code></pre>
<p>In your machine, <code>gmx</code> should point to a working MPI installation of Gromacs.
This script will generate a number of folders, each with a scaled topology file <code>scaled.top</code>. 
Because we have generated the run input files for Gromacs, we can simply run the
simulations using</p>
<pre><code>mpiexec -np 4  gmx_mpi mdrun -s alaTB_ff03_tip3p_nvt -multidir rep*  -nsteps 1000000 -plumed ../plumed.dat -hrex -replex 500 -v
</code></pre>
<p>Note that, as I did, you may need the flag <code>--mca opal_cuda_support 1</code> for running the simulations
with GPU support.</p>
<p>You can next verify whether your replica scheme has been successful demuxing the trajectories
using the <code>demux.pl</code> script included in the Gromacs distribution:</p>
<pre><code>perl demux.pl rep0/md.log
</code></pre>
<p>Again, you will likely need to provide the full path to the Perl script.
Additionally, you can analyze the results to verify how much additional sampling has been
done through the replica exchange scheme. We have included a Python notebook with some
rudimentary analysis.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../metadynamics/metadynamics-with-Q/" class="btn btn-neutral float-left" title="Defining Q as collective variable"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../dipc/" class="btn btn-neutral float-right" title="PLUMED@DIPC">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../metadynamics/metadynamics-with-Q/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../dipc/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
